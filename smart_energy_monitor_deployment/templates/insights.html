{% extends "base.html" %}

{% block title %}AI Insights - Smart Energy Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-brain"></i> AI Energy Insights
            <small class="text-muted">Powered by gpt-oss</small>
        </h1>
    </div>
</div>

<!-- Home Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-home"></i> Home Energy Analysis
                    <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshHomeAnalysis()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </h5>
            </div>
            <div class="card-body" id="home-analysis">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Insights -->
<div class="row">
    <div class="col-12">
        <h3 class="mb-3">Device-Specific Insights</h3>
        <div class="row" id="device-insights">
            <!-- Device insights will be loaded here -->
        </div>
    </div>
</div>

<!-- Daily Report -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day"></i> Daily Energy Report
                </h5>
            </div>
            <div class="card-body" id="daily-report">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadInsights() {
    await Promise.all([
        loadHomeAnalysis(),
        loadDeviceInsights(),
        loadDailyReport()
    ]);
}

async function loadHomeAnalysis() {
    try {
        const response = await fetch('/api/home_analysis');
        const analysis = await response.json();
        
        const homeAnalysisDiv = document.getElementById('home-analysis');
        
        if (analysis.error) {
            homeAnalysisDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> ${analysis.error}
                </div>
            `;
            return;
        }
        
        const insightsHtml = analysis.insights.map(insight => `
            <div class="alert alert-info insight-card">
                <i class="fas fa-lightbulb"></i> ${insight}
            </div>
        `).join('');
        
        const recommendationsHtml = analysis.recommendations.map(rec => `
            <div class="alert alert-success recommendation-card">
                <i class="fas fa-leaf"></i> ${rec}
            </div>
        `).join('');
        
        homeAnalysisDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-bar"></i> Energy Summary</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Devices:</span>
                            <strong>${analysis.total_devices}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Energy:</span>
                            <strong>${analysis.total_energy_kwh} kWh</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Cost:</span>
                            <strong>$${analysis.total_cost.toFixed(4)}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Peak Hours:</span>
                            <strong>${analysis.peak_hours.join(', ')}:00</strong>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-trophy"></i> Top Energy Consumers</h6>
                    <div class="list-group">
                        ${Object.entries(analysis.device_summary)
                            .sort((a, b) => b[1].avg_power_watts - a[1].avg_power_watts)
                            .slice(0, 5)
                            .map(([device, stats]) => `
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>${device}</span>
                                    <strong>${stats.avg_power_watts.toFixed(1)}W</strong>
                                </div>
                            `).join('')}
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-lightbulb"></i> AI Insights</h6>
                    ${insightsHtml}
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-leaf"></i> Recommendations</h6>
                    ${recommendationsHtml}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading home analysis:', error);
        document.getElementById('home-analysis').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> Error loading analysis
            </div>
        `;
    }
}

async function loadDeviceInsights() {
    try {
        const devicesResponse = await fetch('/api/devices');
        const devices = await devicesResponse.json();
        
        const deviceInsightsDiv = document.getElementById('device-insights');
        deviceInsightsDiv.innerHTML = '';
        
        // Load insights for devices with recent activity
        const readingsResponse = await fetch('/api/current_readings');
        const readings = await readingsResponse.json();
        
        const activeDevices = devices.filter(device => {
            const reading = readings.find(r => r.device_id === device.id);
            return reading && reading.power_watts > 0;
        });
        
        for (const device of activeDevices.slice(0, 6)) { // Limit to 6 devices
            const analysisResponse = await fetch(`/api/device_analysis/${device.id}`);
            const analysis = await analysisResponse.json();
            
            if (!analysis.error) {
                const deviceCard = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-plug"></i> ${device.name}
                                    <small class="text-muted">(${analysis.statistics.efficiency_score}/100)</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <small class="text-muted">Average Power:</small>
                                    <div class="h5">${analysis.statistics.avg_power_watts.toFixed(1)}W</div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>AI Insights:</h6>
                                    ${analysis.insights.slice(0, 2).map(insight => `
                                        <div class="alert alert-info py-2 small">${insight}</div>
                                    `).join('')}
                                </div>
                                
                                ${analysis.recommendations.length > 0 ? `
                                    <div>
                                        <h6>Recommendations:</h6>
                                        ${analysis.recommendations.slice(0, 1).map(rec => `
                                            <div class="alert alert-success py-2 small">${rec}</div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDevice('${device.id}')">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                deviceInsightsDiv.innerHTML += deviceCard;
            }
        }
        
        if (activeDevices.length === 0) {
            deviceInsightsDiv.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No active devices found. Start collecting data to see insights.
                    </div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading device insights:', error);
    }
}

async function loadDailyReport() {
    try {
        const response = await fetch('/api/daily_report');
        const report = await response.json();
        
        const dailyReportDiv = document.getElementById('daily-report');
        
        if (report.error) {
            dailyReportDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> ${report.error}
                </div>
            `;
            return;
        }
        
        const topConsumersHtml = Object.entries(report.top_energy_consumers || {})
            .map(([device, cost]) => `
                <li class="list-group-item d-flex justify-content-between">
                    <span>${device}</span>
                    <strong>$${cost.toFixed(4)}</strong>
                </li>
            `).join('');
        
        const insightsHtml = report.insights.map(insight => `
            <div class="alert alert-info py-2">${insight}</div>
        `).join('');
        
        const recommendationsHtml = report.recommendations.map(rec => `
            <div class="alert alert-success py-2">${rec}</div>
        `).join('');
        
        dailyReportDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <h6>Daily Summary</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Date:</span>
                            <strong>${report.summary.date}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Energy:</span>
                            <strong>${report.summary.total_energy_kwh.toFixed(4)} kWh</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Cost:</span>
                            <strong>$${report.summary.total_cost.toFixed(4)}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Peak Power:</span>
                            <strong>${report.summary.peak_power_watts.toFixed(1)}W</strong>
                        </li>
                    </ul>
                </div>
                
                <div class="col-md-4">
                    <h6>Top Consumers</h6>
                    <ul class="list-group">
                        ${topConsumersHtml}
                    </ul>
                </div>
                
                <div class="col-md-4">
                    <h6>Daily Insights</h6>
                    ${insightsHtml}
                    ${recommendationsHtml}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading daily report:', error);
        document.getElementById('daily-report').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> Error loading daily report
            </div>
        `;
    }
}

function refreshHomeAnalysis() {
    document.getElementById('home-analysis').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    loadHomeAnalysis();
}

function viewDevice(deviceId) {
    window.location.href = `/device/${deviceId}`;
}

// Initial load
loadInsights();
</script>
{% endblock %}